name: Deploy webpage to cPanel
run-name: "Deploy: ${{ github.event.head_commit.message }}"

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install rsync
        run: sudo apt-get update && sudo apt-get install -y rsync openssh-client

      - name: Setup SSH
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Decode private key from base64 secret (prevents newline/format corruption)
          echo "${{ secrets.SSH_KEY_B64 }}" | base64 -d > ~/.ssh/github_actions_ed25519
          chmod 600 ~/.ssh/github_actions_ed25519

          # Add server host key (no interactive prompt)
          ssh-keyscan -p "${{ secrets.SSH_PORT }}" -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Verify key is readable
        shell: bash
        run: |
          ssh-keygen -lf ~/.ssh/github_actions_ed25519

      - name: Test SSH connection
        shell: bash
        run: |
          ssh -i ~/.ssh/github_actions_ed25519 \
            -p "${{ secrets.SSH_PORT }}" \
            -o BatchMode=yes \
            -o StrictHostKeyChecking=yes \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" "echo SSH_OK"

      - name: Deploy to cPanel public_html
        shell: bash
        run: |
          # IMPORTANT:
          # Use ./Halil/ (trailing slash) to sync the CONTENTS of Halil into public_html
          # img ve assets altındaki .webp dosyaları ve klasörleri sunucuda korunur, silinmez ve güncellenmez
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='img/***' \
            --exclude='assets/logo.webp' \
            --exclude='assets/awards/***' \
            --exclude='assets/home/***' \
            --exclude='assets/projects/***' \
            --exclude='assets/studio/***' \
            -e "ssh -i ~/.ssh/github_actions_ed25519 -p ${{ secrets.SSH_PORT }} -o BatchMode=yes -o StrictHostKeyChecking=yes" \
            ./Halil/ \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/${{ secrets.SSH_USER }}/public_html/"
